#!/bin/bash -e

SCRIPT_PATH="$(dirname -- "${BASH_SOURCE[0]}")"

LAMBDA_DIR=$1

$SCRIPT_PATH/../virtualenv/create
$AWS_LAMBDAS_VIRTUALENV_SOURCE_COMMAND
pip --version

LAMBDA_DEST_FULL_PATH="$AWS_LAMBDAS_ARTIFACTS_BASE_DIR/$LAMBDA_DIR"
LAMBDA_SOURCE_FULL_PATH="$AWS_LAMBDAS_SOURCE_BASE_DIR/$LAMBDA_DIR"

rm -rf $LAMBDA_DEST_FULL_PATH
rm -rf $LAMBDA_DEST_FULL_PATH.zip
mkdir -p $LAMBDA_DEST_FULL_PATH
cp -r "$LAMBDA_SOURCE_FULL_PATH/src/." "$LAMBDA_DEST_FULL_PATH"

pip install -r "$LAMBDA_SOURCE_FULL_PATH/requirements.txt" -t "$LAMBDA_DEST_FULL_PATH"

pushd .
cd $LAMBDA_DEST_FULL_PATH
zip -rq "../${LAMBDA_DIR}.zip" * -x ./tests/\*
popd

rm -rf $LAMBDA_DEST_FULL_PATH
ls -l $AWS_LAMBDAS_ARTIFACTS_BASE_DIR
